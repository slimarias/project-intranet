<template>
	<q-page>
		<q-card class="row  custom-border-radius">
			<section class="col-xs-12 col-md-9 relative-position q-pa-md">
				<div class="full-width" v-if="post">
					<div class="text-body1 text-grey-6 text-bold q-py-md q-ml-sm q-mr-xl border-botton-grey text-uppercase">
						NOTICIAS
					</div>
					<q-btn
							round
							color="primary"
							class="absolute-top-right q-mt-md q-mr-md btn-shadow">
						<q-icon
								name="far fa-newspaper"
								size="xs"/>
					</q-btn>
					<div class="full-width q-pa-sm">
						<div class="float-left q-pa-sm" style="width: 33%">
							<q-img :src="post.mainImage.path" :ratio="1" class="rounded-borders custom-border-radius"/>
						</div>
						<div class="q-pa-sm">
							<div class="post-overlay q-px-sm">
								<p>
								<span class="post-comments text-caption text-capitalize">
									{{ post.title }}
								</span>
								</p>
							</div>
							<div class="post-info-date q-pt-sm text-caption text-grey-5 q-px-sm">
								{{ post.createdAt | date }}
							</div>
							<div class="post-info  text-grey-7 line-clamp q-px-sm" v-html="post.description">
								{{ post.description }}
							</div>
						</div>
					</div>
				</div>
				<div class="absolute-center full-width" v-else>
					<not-result />
				</div>
			</section>
			<section class="col-md-3 q-pa-none">
				<relatedPostsList :slug="$route.params.category" v-if="$route.params.category" />
			</section>
		</q-card>
		<inner-loading
				:visible="visible"/>
	</q-page>
</template>

<script>
  import postGrid from '../../_components/postsGrid'
  import listCategories  from '../../_components/qblog/list-categories'
  import relatedPostsList from '../../_components/relatedPostsList'
  import moment from 'moment'
  export default {
    name: "news",
	components:{
      postGrid,
      listCategories,
	  relatedPostsList,
	},
	data(){
    	return{
    		slug: null,
			post: {},
			visible: false,
		}
	},
	mounted(){
		this.$root.$off('page.data.refresh')
		this.$root.$on('page.data.refresh', () => this.getPost(true))
    	this.getPost(true)
	},
	watch:{
		'$route.params'(){
			this.getPost(true)
		}
	},
	methods:{
		getPost(refresh){
			this.visible = true
			this.slug = this.$route.params.slugPost || null
			let params = {
				refresh: refresh,
				params: {},
			}
			if(this.slug !== null) {
				params.params = {
					filter: {
						field: isNaN(this.slug) ? 'slug' : 'id',
					}
				}
				this.$crud.show('apiRoutes.qblog.posts', this.slug, params)
					.then(response => {
						//this.$helper.array.builTree
						this.post = response.data
						this.visible = false
					})
					.catch(error => {
						this.post = {}
						this.$alert.error({message: 'Error', timeOut: 4000})
						this.visible = false
					})
			}else{
				this.post = {}
				this.visible = false
			}
		},
	},
	filters:{
		date: function (value){
			  return moment(value).format('d MMMM, YYYY')
		}
	},
  }
</script>

<style scoped>
	.border-botton-grey{
		border-bottom: 1px solid #9e9e9e52
	}
</style>