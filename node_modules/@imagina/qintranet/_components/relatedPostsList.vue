<template>
	<div class="relative-position full-height bg-grey-1">
		<div class="text-h6 bg-primary text-white" style="border-radius: 0 15px 0 0">
			<q-list highlight no-border>
				<q-item>
					<q-item-section avatar>
						<q-icon name="arrow_right_alt" />
					</q-item-section>
					<q-item-section>
						<q-item-label class="text-capitalize q-my-md">
							Noticias Destacadas
						</q-item-label>
					</q-item-section>
				</q-item>
			</q-list>
		</div>
		<div class="row">
			<div class="col-12">
				<q-list highlight no-border v-if="posts.length > 0">
					<q-item
							clickable
							bordered
							class="items-category"
							exact
							@click.native="redirectTo(post)"
							v-for="(post, index) in posts"
							:key="index">
						<q-item-section>
							<div class="row q-col-gutter-sm">
								<div class="col-3">
									<q-img :src="post.mainImage.path" :ratio="16/9" class="rounded-borders custom-border-radius"/>
								</div>
								<div class="col-9">
									<div class="post-overlay">
										<span class="post-comments text-caption text-capitalize">
											{{ post.title }}
										</span>
									</div>
								</div>
							</div>
						</q-item-section>
					</q-item>
				</q-list>
				<div class="absolute-center full-width" v-else>
					<not-result />
				</div>
			</div>
		</div>
		<inner-loading
				:visible="visible"/>
	</div>
</template>

<script>
	import listCategoriesChildren from '@imagina/qintranet/_components/qblog/list-categories-children'
	export default {
		name:'relatedPostsList',
		components:{
			listCategoriesChildren
		},
		props:{
			slug:{
				default: null
			}
		},
		watch:{
			slug(){
				this.getPosts(true)
			}
		},
		data(){
			return{
				visible: false,
				posts: [],
			}
		},
		created() {
			this.getPosts(true)
		},
		methods:{
			getPosts(refresh){
				this.visible = true
				let params = {
					refresh: refresh,
					params: {},
				}
				if(this.slug !== null) {
					params.params = {
						include: 'posts',
						filter: {
							field: isNaN(this.slug) ? 'slug' : 'id',
						}
					}
					this.$crud.show('apiRoutes.qblog.categories', this.slug, params)
							.then(response => {
								//this.$helper.array.builTree
								this.posts = response.data.posts
								this.visible = false
							})
							.catch(error => {
								this.categories = []
								this.$alert.error({message: 'Error', timeOut: 4000})
								this.visible = false
							})
				}else{
					this.$crud.index('apiRoutes.qblog.posts', params)
							.then(response => {
								//this.$helper.array.builTree
								this.posts = response.data
								this.visible = false
							})
							.catch(error => {
								this.posts = []
								this.$alert.error({message: 'Error', timeOut: 4000})
								this.visible = false
							})
				}
			},
			redirectTo(post){
				this.$router.push({
					name: 'qintranet.news.post',
					params:{
						category: this.slug,
						slugPost: post.slug,
					}
				})
			}
		}
	}
</script>
