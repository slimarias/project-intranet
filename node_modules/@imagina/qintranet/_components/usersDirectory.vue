<template>
	<div class="row">
		<div class="col-12 q-px-sm q-py-sm">
			<div class="row flex justify-end">
				<div class="col-4">
					<q-input  v-model="search" label="Filtro">
						<template v-slot:control>
							<div class="self-center full-width no-outline" tabindex="0">{{search}}</div>
						</template>
						<template v-slot:append>
							<q-icon v-if="search !== ''" name="close" class="cursor-pointer" @click="search = ''"/>
							<q-icon name="search" />
						</template>
					</q-input>
				</div>
			</div>
		</div>
		<div
			v-for="(user, key) in users"
			:key="key" @click="()=> {selectedUser = user;showModal = true}"
			class="col-xs-12 col-sm-12 col-lg-6 q-px-sm q-py-sm cursor-pointer">
			<q-card class="my-card no-shadow">
				<q-card-section>
					<div class="container">
						<div class="user-image flex flex-center">
							<q-avatar size="150px">
								<q-img :src="user.mainImage" />
							</q-avatar>
						</div>
						<div class="user-info">
							<div class="row">
								<div class="col-12">
									<div class="text-h6 q-py-md">
										{{ user.fullName }}
									</div>
									<q-separator class="q-mb-md" />
									<div v-if="user.contacts.value.length">
										<q-icon color="primary" name="fas fa-phone" size="xs"/>
										<span class="text-bold q-pl-xs">{{ $tr('ui.form.phone') }}:</span>
										<span v-for="(contact, key) in user.contacts.value" :key="key">
											{{contact.phone}}
										</span>
									</div>
									<div v-if="user.fields.cellularPhone.value !== null">
										<q-icon color="primary" name="fab fa-whatsapp" size="xs"/>
										<span class="text-bold q-pl-xs">
											Celular:
										</span>
										<span class="text-caption">
											{{user.fields.cellularPhone.value}}
										</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</q-card-section>
			</q-card>
		</div>
		<userProfileModal :user="selectedUser" v-model="showModal"/>
	</div>
</template>

<script>
  import userProfileModal from "./userProfileModal";

  export default {
    name: "usersDirectory",
    components:{
      userProfileModal
    },
    data(){
      return{
        loading: false,
        users: [],
		selectedUser: {},
		showModal: false,
        page: 1,
        take: 20,
        lastPage: 1,
        search: '',
      }
    },
	watch:{
      search: function () {
	      this.users = []
        this.page = 1
        this.take = 20
        this.lastPage = 1
	      this.getUsers()
      }
	},
	computed:{
		defaultFields () {
			return [
				{ name: 'cellularPhone', value: null },
				{ name: 'birthday', value: null },
				{ name: 'identification', value: null },
				{ name: 'mainImage', value: {} },
				{ name: 'email', value: null },
				{ name: 'socialNetworks', value: [] },
				{ name: 'contacts', value: [] },
				{ name: 'products', value: [] }
			]
		}
	},
    mounted() {
      this.$nextTick( () => {
        this.getUsers()
      })
    },
    methods:{
      getUsers(){
        this.loading = true
        const params = {
          params: {
            filter: {
              search: this.search
            },
            include: 'addresses,fields',
            page: this.page,
            take: this.take,
          }
        }
        this.$crud.index('apiRoutes.quser.users', params)
          .then( response => {
          	let resp = this.$clone(response.data)
			for(let x in resp){
				resp[x].fields = this.$helper.convertToFrontField(this.defaultFields,resp[x].fields)
			}
            this.users.push(...resp)
            this.take = response.meta.page.perPage
            this.lastPage = response.meta.page.lastPage
            this.loading = false
          })
          .catch( error => {
            this.$alert.error({message: this.$tr('ui.message.errorRequest'), pos: 'bottom'})
            this.loading = false
          })
      },
      getMorePosts(){
        this.page = this.page + 1
        this.getUsers()
      },
    }
  }
</script>

<style lang="stylus">
	.container
		display: grid;
		grid-template-columns: 200px 1fr;

	.user-image
		grid-column-end: span 1;

	.user-info
		grid-column-end: span 1;

	@media screen and (max-width: 768px)
		.container
			display: grid;
			grid-template-columns: 1fr;
			grid-template-rows: 1fr;
			grid-gap: 15px;
		.user-info
			grid-column-end: span 1;
			grid-row-end: span 1;

</style>