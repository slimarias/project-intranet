<template>
  <div id="uploadImageComponent">
    <!--Preview of image-->
    <div class="img-file" :style="stylesImage">
      <!--Content to upload image-->
      <div class="content-manage-file text-center">
        <!--Button edit image-->
        <q-btn icon="fas fa-camera" :color="color" :loading="loading" rounded>
          <q-menu>
            <!--Change or upload image-->
            <q-item @click.native="uploadFile()" clickable v-close-popup>
              <q-item-section avatar>
                <q-icon name="fas fa-file-image" :color="color"/>
              </q-item-section>
              <q-item-section>
                {{(this.file == '') ? $tr('ui.message.uploadImage') : $tr('ui.message.changeImage')}}
              </q-item-section>
            </q-item>
            <!--Remove image-->
            <q-item v-if="this.file != ''" clickable v-close-popup
                    @click.native="removeFile()">
              <q-item-section avatar>
                <q-icon name="fas fa-trash" :color="color"/>
              </q-item-section>
              <q-item-section>{{$tr('ui.message.deleteImage')}}</q-item-section>
            </q-item>
          </q-menu>
        </q-btn>
      </div>
      <!--Loading-->
      <div class="loading" v-if="loading">
        <inner-loading :visible="loading"/>
      </div>
    </div>
    <!--Uploader image-->
    <q-uploader url="" ref="uploadComponent" v-model="file" v-show="false"
                @added="setFile" extensions=".jpg" accept=".jpg, image/*"/>
  </div>
</template>

<script>
  export default {
    props: {
      color: {default: 'primary'},
      rounded: {type: Boolean, default: false},
      width: {default: '180px'},
      height: {default: '180px'},
      value: {default: null},
      defaultImage: {default: false}
    },
    components: {},
    watch: {
      value() {
        this.loadImage()
      }
    },
    mounted() {
      this.$nextTick(function () {
        this.loadImage()
      })
    },
    data() {
      return {
        loading: false,
        file: ''
      }
    },
    computed: {
      //Return path image
      getImageUrl() {
        if (this.file != '') return this.file//If file exist, add to path
        return this.defaultImage || this.defaultImg//Return path image
      },
      //Return styles to image
      stylesImage() {
        return `
        background-image: url(${this.getImageUrl});
        width : ${this.width};
        height: ${this.height};
        border-radius: ${this.rounded ? '50%' : '10px'}
      `
      },
      //Default image
      defaultImg() {
        return `${this.$store.state.qsiteApp.baseUrl}/modules/iprofile/img/default.jpg`
      }
    },
    methods: {
      //load image from value prop if exist
      loadImage() {
        if (this.value) this.file = this.$clone(this.value)
      },
      //Dispath upload file event
      async uploadFile() {
        this.$refs.uploadComponent.reset()
        setTimeout(() => {
          this.$refs.uploadComponent.pickFiles()
        }, 500);
      },
      //Add image to data file
      setFile(files) {
        this.loading = true
        setTimeout(() => {
          this.file = files[0].__img.src
          this.$emit('input', this.file)
          this.loading = false
        }, 500)
      },
      //Remove file
      removeFile() {
        return new Promise((resolve, reject) => {
          if (this.file != '') {
            this.loading = true
            setTimeout(() => {
              this.$refs.uploadComponent.reset()
              this.file = ''
              this.loading = false
              this.$emit('input', this.file)
              return resolve(true)
            }, 500)
          } else {
            return resolve(true)
          }
        })
      }
    }
  }
</script>

<style lang="stylus">
  #uploadImageComponent
    margin 0 auto

    .img-file
      position relative
      margin 0 auto
      margin-bottom 22px
      background-size cover
      background-position center
      background-repeat no-repeat
      max-width 100%

      .content-manage-file
        position absolute
        bottom 0
        right 5%

        .q-btn
          height 45px !important
          width 45px !important
          width max-content

      .loading
        position absolute
        height 100%
        width 100%
        overflow hidden
        border-radius 50%
</style>
